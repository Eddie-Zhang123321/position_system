<view class="container">
  <!-- 页面标题 -->
  <view class="page-header">
    <text class="title">考研教室座位</text>
    <view class="subtitle">点击可用座位进行选座，已选座位可扫码签到</view>
  </view>

  <!-- 用户绑定状态 -->
  <view class="user-seat-status card" wx:if="{{userInfo}}">
    <view class="flex-between">
      <view>
        <text>{{userInfo.name}}</text>
        <text wx:if="{{hasBoundSeat}}" class="bound-seat-info">已绑定座位: {{boundSeatId}}</text>
      </view>
      <view class="seat-status">
        <text wx:if="{{hasBoundSeat}}" class="status-bound">已使用</text>
        <text wx:else class="status-available">未绑定</text>
      </view>
    </view>
    
    <!-- 解绑按钮 -->
    <button 
      wx:if="{{hasBoundSeat}}"
      class="btn-unbind"
      bindtap="unbindSeat"
      data-id="{{boundSeatId}}"
      size="mini"
      type="warn"
    >解绑座位</button>
  </view>

  <!-- 加载状态 -->
  <view class="loading-container" wx:if="{{isLoading}}">
    <van-loading size="24px" color="#4A90E2" /> 加载中...
  </view>

  <!-- 座位网格 -->
  <view class="seat-grid" wx:else>
    <block wx:for="{{tables}}" wx:key="id">
      <view 
        class="seat-item {{item.statusClass}}" 
        bindtap="selectTable"
        data-id="{{item.id}}"
      >
        <view class="seat-id">座位 {{item.id}}</view>
        <view class="seat-status">{{item.statusText}}</view>
        
        <!-- 显示绑定用户信息 -->
        <view class="seat-info" wx:if="{{item.status === 'bound'}}">
          <text class="bound-user">{{item.bind_user}}</text>
        </view>
        
        <!-- 操作按钮 -->
        <view class="seat-actions" wx:if="{{item.status === 'available'}}">
          <button 
            class="action-btn select-btn"
            size="mini"
          >选座</button>
        </view>
        
        <view class="seat-actions" wx:if="{{item.status === 'bound' && hasBoundSeat && boundSeatId == item.id}}">
          <button 
            class="action-btn qr-btn"
            size="mini"
            catchtap="getSeatQRCode"
            data-id="{{item.id}}"
          >二维码</button>
          <button 
            class="action-btn sign-btn"
            size="mini"
            catchtap="goSign"
            data-id="{{item.id}}"
          >签到</button>
        </view>
      </view>
    </block>
  </view>

  <!-- 提示信息 -->
  <view class="tips">
    <text>🟢 可用座位 | 🔴 已绑定座位</text>
  </view>

  <!-- 二维码模态框 -->
  <van-popup show="{{showQRCode}}" position="center" bind:close="closeQRCode">
    <view class="qr-content">
      <view class="qr-header">
        <text class="qr-title">座位 {{qrCodeId}} 二维码</text>
        <van-icon name="close" size="24px" bindtap="closeQRCode" />
      </view>
      <image class="qr-image" src="{{qrCodeImage}}" mode="aspectFit"></image>
      <text class="qr-desc">扫描此二维码进行签到</text>
    </view>
  </van-popup>
</view>
